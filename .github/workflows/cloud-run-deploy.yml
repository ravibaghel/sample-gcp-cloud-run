name: Build and push Docker image to Artifact Registry and deploy to Cloud Run

on:
  workflow_dispatch:
  # keep optional push trigger commented out; you can enable if desired
  # push:
  #   branches: [ main ]

env:
  # IMAGE will be constructed from secrets: REGION, PROJECT, REPO and IMAGE_NAME
  IMAGE: ${{ secrets.CLOUD_RUN_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/${{ secrets.ARTIFACT_REGISTRY_REPO }}/demo:${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build with Maven
        run: mvn -B -DskipTests package

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Install gcloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Configure gcloud project
        run: |
          gcloud config set project ${{ secrets.GCP_PROJECT }}
          gcloud config set run/region ${{ secrets.CLOUD_RUN_REGION }}

      - name: Show computed image and verify Artifact Registry repository
        run: |
          REPO_NAME="${{ secrets.ARTIFACT_REGISTRY_REPO }}"
          REGION="${{ secrets.CLOUD_RUN_REGION }}"
          PROJECT="${{ secrets.GCP_PROJECT }}"
          echo "Computed IMAGE: $IMAGE"
          echo "Verifying Artifact Registry repository '$REPO_NAME' in region '$REGION' for project '$PROJECT'..."
          if ! gcloud artifacts repositories describe "$REPO_NAME" --location="$REGION" --project="$PROJECT" >/dev/null 2>&1; then
            echo "ERROR: Artifact Registry repository '$REPO_NAME' not found in region '$REGION' for project '$PROJECT'"
            echo "Listing repositories in region '$REGION'..."
            gcloud artifacts repositories list --location="$REGION" --project="$PROJECT" || true
            exit 1
          fi
          echo "Repository '$REPO_NAME' exists in region '$REGION'."

      - name: Configure Docker to use gcloud credential helper for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.CLOUD_RUN_REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image to Artifact Registry
        run: |
          docker build -t $IMAGE .
          docker push $IMAGE

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy demo-service \
            --image $IMAGE \
            --region ${{ secrets.CLOUD_RUN_REGION }} \
            --platform managed \
            --project ${{ secrets.GCP_PROJECT }} \
            --allow-unauthenticated

      - name: Output Cloud Run service URL
        run: |
          SERVICE_NAME="demo-service"
          PROJECT="${{ secrets.GCP_PROJECT }}"
          REGION="${{ secrets.CLOUD_RUN_REGION }}"
          echo "Retrieving URL for service: $SERVICE_NAME (project=$PROJECT, region=$REGION)"
          URL=$(gcloud run services describe "$SERVICE_NAME" --platform managed --region "$REGION" --project "$PROJECT" --format="value(status.url)" 2>/dev/null || true)
          if [ -n "$URL" ]; then
            echo "Cloud Run service URL: $URL"
          else
            echo "WARNING: Cloud Run service URL not found. Deployment may not have completed or service might not be ready yet."
            echo "You can check status with: gcloud run services describe $SERVICE_NAME --platform managed --region $REGION --project $PROJECT"
          fi
